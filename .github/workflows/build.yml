# .github/workflows/build-test-deploy.yml
name: Build, Test, Secret Scan, Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
    # Checkout the code
    - name: Checkout repository
      uses: actions/checkout@v3

    # Set up Node.js (adjust version as needed)
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # Install dependencies
    - name: Install dependencies
      run: npm install

    # Run tests
    - name: Run tests
      run: npm test

    # Secret scanning using truffleHog
    - name: Scan for secrets with TruffleHog
      uses: trufflesecurity/trufflehog@v3
      with:
        scanArguments: '--only-verified --json'

    # Fail if secrets are found
    - name: Check TruffleHog output
      run: |
        if grep -q "Verified" <<< "$(cat results.json || true)"; then
          echo "❌ Secret detected! Failing build."
          exit 1
        else
          echo "✅ No secrets found."
        fi

    # Build step (e.g., build app or bundle)
    - name: Build the application
      run: npm run build

    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
       name: my-build-artifact
       path: |
         artifacts/
      
